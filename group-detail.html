<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Group Details - SplitEasy</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <!-- Header -->
    <header class="group-header">
        <div class="container">
            <div class="group-header-left">
                <button class="btn-back" id="backBtn" onclick="goBack()">‚Üê</button>
                <div class="group-info">
                    <h1 id="groupName">Loading...</h1>
                    <p id="groupMeta">Loading group details...</p>
                </div>
            </div>
            <div class="group-actions">
                <button class="btn-secondary" id="shareBtn" onclick="shareGroup()">Share</button>
                <button class="btn-success" id="editBtn" onclick="handleEditGroup()">Edit</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Total Expenses Card -->
        <div class="total-expenses">
            <h2 id="totalExpensesAmount">‚Çπ0.00</h2>
            <p>Total Expenses</p>
        </div>

        <!-- Expenses Section -->
        <section class="expenses-section">
            <div class="section-header">
                <h3>Expenses</h3>
                <button class="btn-success" onclick="showAddExpenseModal()">Add Expense</button>
            </div>
            <div id="expensesList" class="expenses-list">
                <!-- Expenses will be loaded here -->
            </div>
            <div id="noExpenses" class="empty-state">
                <p>No Expenses Yet</p>
                <p>Add your first expense to start tracking group spending!</p>
                <button class="btn-success btn-large" onclick="showAddExpenseModal()">Add First Expense</button>
            </div>
        </section>

        <!-- Balances Section -->
        <section class="balances-section">
            <h3>Balances & Settlements</h3>
            <div id="balancesList" class="balances-list">
                <!-- Balances will be calculated and shown here -->
            </div>
        </section>
    </main>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Expense</h3>
                <span class="close" onclick="closeAddExpenseModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="expenseDescription">Description</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Dinner, Gas, Groceries" required>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Amount (‚Çπ)</label>
                    <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="expensePaidBy">Paid By</label>
                    <select id="expensePaidBy" required>
                        <option value="">Select who paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Split Between</label>
                    <div class="selection-container">
                        <div class="selection-header">
                            <span>Select Members</span>
                            <div class="selection-actions">
                                <button class="selection-action" onclick="selectAllExpenseMembers()">Select All</button>
                                <button class="selection-action" onclick="clearAllExpenseMembers()">Clear All</button>
                            </div>
                        </div>
                        <div class="selectable-grid" id="expenseSplitGrid">
                            <!-- Member checkboxes will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeAddExpenseModal()">Cancel</button>
                <button type="button" class="btn-success" onclick="addExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Expense</h3>
                <span class="close" onclick="closeEditExpenseModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editExpenseDescription">Description</label>
                    <input type="text" id="editExpenseDescription" placeholder="e.g., Dinner, Gas, Groceries" required>
                </div>
                <div class="form-group">
                    <label for="editExpenseAmount">Amount (‚Çπ)</label>
                    <input type="number" id="editExpenseAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editExpensePaidBy">Paid By</label>
                    <select id="editExpensePaidBy" required>
                        <option value="">Select who paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Split Between</label>
                    <div class="selection-container">
                        <div class="selection-header">
                            <span>Select Members</span>
                            <div class="selection-actions">
                                <button class="selection-action" onclick="selectAllEditExpenseMembers()">Select All</button>
                                <button class="selection-action" onclick="clearAllEditExpenseMembers()">Clear All</button>
                            </div>
                        </div>
                        <div class="selectable-grid" id="editExpenseSplitGrid">
                            <!-- Member checkboxes will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeEditExpenseModal()">Cancel</button>
                <button type="button" class="btn-success" onclick="saveExpenseChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Share Group Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Share Group</h3>
                <span class="close" onclick="closeShareModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="shareLink">Share Link</label>
                    <input type="text" id="shareLink" readonly>
                    <button type="button" class="btn-success" onclick="copyShareLink()">Copy</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Group</h3>
                <span class="close" onclick="closeEditGroupModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editGroupName">Group Name</label>
                    <input type="text" id="editGroupName" required>
                </div>
                <div class="form-group">
                    <label>Members</label>
                    <div class="selection-container">
                        <div class="selection-header">
                            <span>Edit Members</span>
                            <div class="selection-actions">
                                <button class="selection-action" onclick="selectAllGroupMembers()">Select All</button>
                                <button class="selection-action" onclick="clearAllGroupMembers()">Clear All</button>
                            </div>
                        </div>
                        <div class="selectable-grid" id="editGroupMembersGrid">
                            <!-- Members will be loaded here -->
                        </div>
                        <div class="add-item-section">
                            <input type="text" class="add-item-input" id="editGroupNewMemberInput" placeholder="Add new member">
                            <button class="btn-add" onclick="addNewGroupMember()" title="Add member">+</button>
                        </div>
                        <div class="dynamic-items" id="editGroupDynamicMembers">
                            <!-- Dynamically added members will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-with-delete">
                <div class="modal-footer-left">
                    <button type="button" class="btn-danger" onclick="deleteGroupConfirm()">Delete Group</button>
                </div>
                <div class="modal-footer-right">
                    <button type="button" class="btn-secondary" onclick="closeEditGroupModal()">Cancel</button>
                    <button type="button" class="btn-success" onclick="saveGroupChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentGroup = null;
        let currentGroupId = null;
        let editingExpenseId = null;
        let dynamicMemberCounter = 0;

        // Store group globally so it's accessible everywhere
        window.currentGroup = null;

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Group Detail Page Loading...');
            console.log('Current URL:', window.location.href);
            console.log('URL search:', window.location.search);

            // Initialize Supabase if available
            if (typeof window.initializeSupabase === 'function') {
                try {
                    window.initializeSupabase();
                } catch (error) {
                    console.warn('Supabase initialization failed:', error);
                }
            }

            // CRITICAL: Initialize user session first
            const userData = localStorage.getItem('spliteasy_current_user');
            if (userData) {
                try {
                    window.currentUser = JSON.parse(userData);
                    console.log('üë§ User session restored for group detail:', window.currentUser.name);
                } catch (error) {
                    console.error('Failed to parse user data:', error);
                    // Don't redirect immediately - might be a shared link
                }
            } else {
                console.warn('‚ö†Ô∏è No user session found');
            }

            // Get group ID from URL with enhanced debugging
            console.log('üìã Parsing URL parameters...');
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL Params object:', urlParams);
            console.log('All URL param entries:', [...urlParams.entries()]);

            const groupId = urlParams.get('id');
            console.log('üéØ Group ID from URL:', groupId);

            if (groupId) {
                console.log('‚úÖ Group ID found, proceeding with load...');
                window.currentGroupId = groupId;
                currentGroupId = groupId;

                loadGroupData(groupId);
            } else {
                console.error('‚ùå No group ID provided in URL');
                console.log('Available URL params:', window.location.search);

                showNotification('No group ID provided', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }

            // Initialize real-time sync for group detail page
            if (window.currentUser && typeof window.startRealtimeSync === 'function') {
                console.log('üîÑ Scheduling real-time sync initialization...');
                setTimeout(() => {
                    window.startRealtimeSync();
                }, 2000); // Give time for group to load
            } else {
                console.log('‚ö†Ô∏è Real-time sync not initialized - missing user or function');
            }
        });

        // ========================================
        // CORE FUNCTIONS - FIXED FOR EXPENSE PERSISTENCE
        // ========================================

        // FIXED: Enhanced loadGroupData with persistent storage
        async function loadGroupData(groupId) {
            console.log('üîç Loading group data for ID:', groupId);

            // First try to load from localStorage - THIS IS CRITICAL
            const groups = loadFromLocalStorage();
            console.log('üìä Loaded groups from localStorage:', groups.length, 'groups found');

            let foundGroup = groups.find(g => g.id === groupId);

            if (foundGroup) {
                console.log('‚úÖ Group found in localStorage:', foundGroup.name);
                console.log('üìã Group has', foundGroup.expenses?.length || 0, 'expenses');

                // CRITICAL: Set both currentGroup references
                currentGroup = foundGroup;
                window.currentGroup = foundGroup;

                // Update display immediately with local data
                updateGroupDisplay();
                return;
            }

            // Group not found locally - try to fetch from database
            console.log('üîÑ Group not found locally, checking database...');
            showNotification('Loading group from link...', 'info');

            if (!window.currentUser) {
                showNotification('Please log in to join this group', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            try {
                // Fetch group from database
                if (typeof window.fetchGroupFromDatabase !== 'function') {
                    throw new Error('Database functions not available');
                }

                const fetchedGroup = await window.fetchGroupFromDatabase(groupId);

                if (!fetchedGroup) {
                    showNotification('Group not found or access denied', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                // Ask user if they want to join the group
                const joinConfirm = confirm(
                    `Do you want to join the group "${fetchedGroup.name}"?\n\n` +
                    `Members: ${fetchedGroup.members.join(', ')}\n` +
                    `Expenses: ${fetchedGroup.expenses?.length || 0}\n` +
                    `Total: ${formatCurrency(fetchedGroup.totalExpenses)}`
                );

                if (!joinConfirm) {
                    showNotification('Group join cancelled', 'info');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                    return;
                }

                // Join user to group in database
                const joined = await window.joinUserToGroup(groupId, window.currentUser.id);

                if (!joined) {
                    showNotification('Failed to join group. Please try again.', 'error');
                    return;
                }

                // Add user to local group data
                if (!fetchedGroup.members.includes(window.currentUser.id)) {
                    fetchedGroup.members.push(window.currentUser.id);
                }

                // CRITICAL: Save group locally with proper structure
                const localGroups = loadFromLocalStorage();
                localGroups.push(fetchedGroup);
                saveGroupsToLocalStorage(localGroups);

                // Set as current group
                currentGroup = fetchedGroup;
                window.currentGroup = fetchedGroup;
                updateGroupDisplay();

                showNotification(`Successfully joined "${fetchedGroup.name}"!`, 'success');

            } catch (error) {
                console.error('Failed to load group from share link:', error);
                showNotification('Failed to load group. Please check your connection.', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // FIXED: Enhanced localStorage functions
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('spliteasy_groups');
                const groups = data ? JSON.parse(data) : [];
                console.log('üìä LoadFromLocalStorage: Found', groups.length, 'groups');
                return groups;
            } catch (error) {
                console.error('‚ùå Error loading from localStorage:', error);
                return [];
            }
        }

        // FIXED: Critical - proper save function that preserves ALL data
        function saveGroupsToLocalStorage(groups) {
            try {
                console.log('üíæ Saving', groups.length, 'groups to localStorage');

                // Ensure each group has proper structure and calculated totals
                groups.forEach((group, index) => {
                    console.log(`üìã Group ${index + 1}: "${group.name}" has ${group.expenses?.length || 0} expenses`);

                    // Ensure expenses array exists
                    if (!group.expenses) {
                        group.expenses = [];
                    }

                    // Calculate total expenses
                    if (group.expenses.length > 0) {
                        group.totalExpenses = group.expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);

                        // Ensure each expense has proper structure
                        group.expenses.forEach(expense => {
                            if (expense.splitBetween && expense.splitBetween.length > 0) {
                                expense.perPersonAmount = parseFloat(expense.amount || 0) / expense.splitBetween.length;
                            }
                        });
                    } else {
                        group.totalExpenses = 0;
                    }
                });

                // Save with detailed logging
                const jsonString = JSON.stringify(groups, null, 2);
                localStorage.setItem('spliteasy_groups', jsonString);
                console.log('‚úÖ Successfully saved groups to localStorage');

                // Verify save
                const verification = localStorage.getItem('spliteasy_groups');
                const parsedVerification = JSON.parse(verification);
                console.log('üîç Verification: Saved', parsedVerification.length, 'groups');

            } catch (error) {
                console.error('‚ùå Failed to save to localStorage:', error);
                showNotification('Failed to save data locally', 'error');
            }
        }

        // FIXED: Critical updateGroupInStorage function
        function updateGroupInStorage() {
            console.log('üîÑ Updating group in storage for group ID:', currentGroupId);

            if (!currentGroup || !currentGroupId) {
                console.error('‚ùå No currentGroup or currentGroupId to update');
                return;
            }

            try {
                // Load all groups from localStorage
                const allGroups = loadFromLocalStorage();
                console.log('üìä Found', allGroups.length, 'total groups in storage');

                // Find the index of the current group
                const groupIndex = allGroups.findIndex(g => g.id === currentGroupId);

                if (groupIndex !== -1) {
                    console.log('üìç Found group at index', groupIndex, 'in localStorage');
                    console.log('üìã Updating with', currentGroup.expenses?.length || 0, 'expenses');

                    // CRITICAL: Replace the entire group object with current data
                    allGroups[groupIndex] = { ...currentGroup };

                    // Update both global references
                    window.currentGroup = currentGroup;

                    // Save back to localStorage
                    saveGroupsToLocalStorage(allGroups);

                    console.log('‚úÖ Successfully updated group in storage');
                } else {
                    console.error('‚ùå Group not found in localStorage for update');
                    // Group doesn't exist, add it
                    allGroups.push(currentGroup);
                    saveGroupsToLocalStorage(allGroups);
                    console.log('‚úÖ Added new group to storage');
                }
            } catch (error) {
                console.error('‚ùå Failed to update group in storage:', error);
            }
        }

        // Helper function to update group display
        function updateGroupDisplay() {
            if (!currentGroup) {
                console.error('No currentGroup to display');
                return;
            }

            console.log('üé® Updating display for group:', currentGroup.name);
            console.log('üìã Group has', currentGroup.expenses?.length || 0, 'expenses to display');

            safeUpdateElement('groupName', currentGroup.name);
            safeUpdateElement('groupMeta', 
                `${currentGroup.members.length} members ‚Ä¢ ${currentGroup.expenses?.length || 0} expenses ‚Ä¢ Created ${formatDate(currentGroup.createdAt)}`
            );
            safeUpdateElement('totalExpensesAmount', formatCurrency(currentGroup.totalExpenses || 0));

            displayExpenses();
            calculateBalances();
        }

        function safeUpdateElement(id, content) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = content;
            } else {
                console.warn(`Element with id '${id}' not found`);
            }
        }

        // FIXED: Enhanced displayExpenses with detailed logging
        function displayExpenses() {
            console.log('üé® DisplayExpenses called');
            console.log('üìã Current group expenses:', currentGroup?.expenses?.length || 0);

            const expensesList = document.getElementById('expensesList');
            const noExpenses = document.getElementById('noExpenses');

            if (!currentGroup || !currentGroup.expenses || currentGroup.expenses.length === 0) {
                console.log('üì≠ No expenses to display');
                if (expensesList) expensesList.style.display = 'none';
                if (noExpenses) noExpenses.style.display = 'block';
                return;
            }

            console.log('üìã Displaying', currentGroup.expenses.length, 'expenses');
            if (expensesList) expensesList.style.display = 'block';
            if (noExpenses) noExpenses.style.display = 'none';

            if (expensesList) {
                expensesList.innerHTML = currentGroup.expenses.map((expense, index) => {
                    console.log(`üí∞ Expense ${index + 1}:`, expense.name, '-', formatCurrency(expense.amount));
                    return `
                        <div class="expense-item">
                            <div class="expense-item-header">
                                <div class="expense-actions">
                                    <button class="expense-action-btn edit" onclick="editExpense('${expense.id}')" title="Edit Expense">‚úèÔ∏è</button>
                                    <button class="expense-action-btn delete" onclick="deleteExpense('${expense.id}')" title="Delete Expense">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="expense-content">
                                <div class="expense-info">
                                    <h4>${expense.name}</h4>
                                    <p>Paid by ${expense.paidBy} ‚Ä¢ Split between ${expense.splitBetween?.join(', ') || 'Unknown'}</p>
                                    <small>${formatDate(expense.date)}</small>
                                </div>
                                <div class="expense-amount">
                                    ${formatCurrency(expense.amount)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('‚úÖ Expenses HTML generated and inserted');
            }
        }

        // FIXED: Enhanced Settlement System
        function calculateBalances() {
            const balancesList = document.getElementById('balancesList');

            if (!balancesList || !currentGroup || !currentGroup.expenses || currentGroup.expenses.length === 0) {
                if (balancesList) {
                    balancesList.innerHTML = '<p class="no-settlements">No expenses to calculate settlements</p>';
                }
                return;
            }

            // Calculate individual balances
            const balances = {};
            currentGroup.members.forEach(member => {
                balances[member] = 0;
            });

            currentGroup.expenses.forEach(expense => {
                const amount = parseFloat(expense.amount);
                const splitBetween = expense.splitBetween || currentGroup.members;
                const perPerson = amount / splitBetween.length;

                // Person who paid gets credited
                if (balances[expense.paidBy] !== undefined) {
                    balances[expense.paidBy] += amount;
                }

                // Everyone who shared the expense gets debited
                splitBetween.forEach(member => {
                    if (balances[member] !== undefined) {
                        balances[member] -= perPerson;
                    }
                });
            });

            // Get creditors and debtors
            const creditors = [];
            const debtors = [];

            Object.entries(balances).forEach(([member, amount]) => {
                if (Math.abs(amount) > 0.01) {
                    if (amount > 0) {
                        creditors.push({ name: member, amount: amount });
                    } else {
                        debtors.push({ name: member, amount: Math.abs(amount) });
                    }
                }
            });

            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);

            // Calculate optimal settlements
            const settlements = [];
            let i = 0, j = 0;

            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];
                const settlementAmount = Math.min(creditor.amount, debtor.amount);

                settlements.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: settlementAmount
                });

                creditor.amount -= settlementAmount;
                debtor.amount -= settlementAmount;

                if (creditor.amount < 0.01) i++;
                if (debtor.amount < 0.01) j++;
            }

            // Display settlements
            if (settlements.length === 0) {
                balancesList.innerHTML = `
                    <div class="settlement-complete">
                        <div class="settlement-icon">‚úÖ</div>
                        <h4>All Settled Up!</h4>
                        <p>No payments needed - everyone is even!</p>
                    </div>
                `;
            } else {
                const settlementHTML = settlements.map(settlement => `
                    <div class="settlement-item">
                        <div class="settlement-content">
                            <div class="settlement-from">
                                <span class="member-name debtor">${settlement.from}</span>
                            </div>
                            <div class="settlement-arrow">
                                <span class="arrow-icon">‚Üí</span>
                                <span class="settlement-amount">${formatCurrency(settlement.amount)}</span>
                            </div>
                            <div class="settlement-to">
                                <span class="member-name creditor">${settlement.to}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                balancesList.innerHTML = `
                    <div class="settlements-list">
                        ${settlementHTML}
                    </div>
                `;
            }
        }

        // ========================================
        // ADD EXPENSE FUNCTIONS - FIXED
        // ========================================
        function showAddExpenseModal() {
            const modal = document.getElementById('addExpenseModal');
            const paidBySelect = document.getElementById('expensePaidBy');
            const splitGrid = document.getElementById('expenseSplitGrid');

            if (modal) modal.style.display = 'block';

            // Populate paid by dropdown
            if (paidBySelect && currentGroup) {
                paidBySelect.innerHTML = '<option value="">Select who paid</option>' +
                    currentGroup.members.map(member => 
                        `<option value="${member}">${member}</option>`
                    ).join('');
            }

            // Populate split between grid
            if (splitGrid && currentGroup) {
                splitGrid.innerHTML = currentGroup.members.map(member => 
                    `<div class="selectable-box selected" data-member="${member}">
                        ${member}
                    </div>`
                ).join('');
            }
        }

        function closeAddExpenseModal() {
            const modal = document.getElementById('addExpenseModal');
            if (modal) modal.style.display = 'none';

            // Reset form
            ['expenseDescription', 'expenseAmount', 'expensePaidBy'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
        }

        function selectAllExpenseMembers() {
            document.querySelectorAll('#expenseSplitGrid .selectable-box').forEach(box => {
                box.classList.add('selected');
            });
        }

        function clearAllExpenseMembers() {
            document.querySelectorAll('#expenseSplitGrid .selectable-box').forEach(box => {
                box.classList.remove('selected');
            });
        }

        // FIXED: Critical addExpense function with proper persistence
        async function addExpense() {
            console.log('üí∞ Adding new expense...');

            const description = document.getElementById('expenseDescription')?.value.trim();
            const amount = document.getElementById('expenseAmount')?.value;
            const paidBy = document.getElementById('expensePaidBy')?.value;
            const selectedBoxes = document.querySelectorAll('#expenseSplitGrid .selectable-box.selected');
            const splitBetween = Array.from(selectedBoxes).map(box => box.dataset.member);

            if (!description || !amount || !paidBy || splitBetween.length === 0) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            const newExpense = {
                id: generateId(),
                name: description,
                amount: parseFloat(amount),
                paidBy: paidBy,
                splitBetween: splitBetween,
                date: new Date().toISOString(),
                perPersonAmount: parseFloat(amount) / splitBetween.length
            };

            console.log('üìù New expense created:', newExpense);

            // CRITICAL: Ensure expenses array exists
            if (!currentGroup.expenses) {
                currentGroup.expenses = [];
                console.log('üìã Initialized expenses array');
            }

            // Add expense to current group
            currentGroup.expenses.push(newExpense);
            console.log('üìä Added expense. Group now has', currentGroup.expenses.length, 'expenses');

            // Recalculate total
            currentGroup.totalExpenses = (currentGroup.totalExpenses || 0) + parseFloat(amount);
            console.log('üí∞ New total expenses:', formatCurrency(currentGroup.totalExpenses));

            // CRITICAL: Save to storage immediately
            updateGroupInStorage();

            // Update UI
            displayExpenses();
            calculateBalances();
            safeUpdateElement('totalExpensesAmount', formatCurrency(currentGroup.totalExpenses));

            // Close modal
            closeAddExpenseModal();

            // Sync to database if available
            if (typeof window.syncExpenseToDatabase === 'function') {
                try {
                    await window.syncExpenseToDatabase(newExpense, currentGroup.id);
                    console.log('‚úÖ Expense synced to database');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to sync expense to database:', error);
                }
            }

            showNotification('Expense added successfully!', 'success');
        }

        // ========================================
        // EDIT EXPENSE FUNCTIONS - FIXED
        // ========================================
        function editExpense(expenseId) {
            const expense = currentGroup.expenses.find(e => e.id === expenseId);
            if (!expense) return;

            editingExpenseId = expenseId;

            // Populate form
            document.getElementById('editExpenseDescription').value = expense.name;
            document.getElementById('editExpenseAmount').value = expense.amount;

            const paidBySelect = document.getElementById('editExpensePaidBy');
            paidBySelect.innerHTML = '<option value="">Select who paid</option>' +
                currentGroup.members.map(member => 
                    `<option value="${member}" ${member === expense.paidBy ? 'selected' : ''}>${member}</option>`
                ).join('');

            // Populate split between grid
            const splitGrid = document.getElementById('editExpenseSplitGrid');
            splitGrid.innerHTML = currentGroup.members.map(member => 
                `<div class="selectable-box ${expense.splitBetween?.includes(member) ? 'selected' : ''}" data-member="${member}">
                    ${member}
                </div>`
            ).join('');

            document.getElementById('editExpenseModal').style.display = 'block';
        }

        function closeEditExpenseModal() {
            document.getElementById('editExpenseModal').style.display = 'none';
            editingExpenseId = null;
        }

        function selectAllEditExpenseMembers() {
            document.querySelectorAll('#editExpenseSplitGrid .selectable-box').forEach(box => {
                box.classList.add('selected');
            });
        }

        function clearAllEditExpenseMembers() {
            document.querySelectorAll('#editExpenseSplitGrid .selectable-box').forEach(box => {
                box.classList.remove('selected');
            });
        }

        // FIXED: Save expense changes with proper persistence
        async function saveExpenseChanges() {
            if (!editingExpenseId) return;

            const description = document.getElementById('editExpenseDescription')?.value.trim();
            const amount = document.getElementById('editExpenseAmount')?.value;
            const paidBy = document.getElementById('editExpensePaidBy')?.value;
            const selectedBoxes = document.querySelectorAll('#editExpenseSplitGrid .selectable-box.selected');
            const splitBetween = Array.from(selectedBoxes).map(box => box.dataset.member);

            if (!description || !amount || !paidBy || splitBetween.length === 0) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            const expenseIndex = currentGroup.expenses.findIndex(e => e.id === editingExpenseId);
            if (expenseIndex !== -1) {
                const oldAmount = parseFloat(currentGroup.expenses[expenseIndex].amount);
                const newAmount = parseFloat(amount);

                currentGroup.expenses[expenseIndex] = {
                    ...currentGroup.expenses[expenseIndex],
                    name: description,
                    amount: newAmount,
                    paidBy: paidBy,
                    splitBetween: splitBetween,
                    perPersonAmount: newAmount / splitBetween.length
                };

                // Update total
                currentGroup.totalExpenses = (currentGroup.totalExpenses || 0) - oldAmount + newAmount;

                // CRITICAL: Save to storage
                updateGroupInStorage();

                // Update UI
                displayExpenses();
                calculateBalances();
                safeUpdateElement('totalExpensesAmount', formatCurrency(currentGroup.totalExpenses));

                // Sync to database
                if (typeof window.syncExpenseToDatabase === 'function') {
                    try {
                        await window.syncExpenseToDatabase(currentGroup.expenses[expenseIndex], currentGroup.id);
                    } catch (error) {
                        console.warn('Failed to sync expense to database:', error);
                    }
                }

                closeEditExpenseModal();
                showNotification('Expense updated successfully!', 'success');
            }
        }

        // FIXED: Delete expense with proper persistence
        async function deleteExpense(expenseId) {
            const expense = currentGroup.expenses.find(e => e.id === expenseId);
            if (!expense) {
                console.error('Expense not found:', expenseId);
                return;
            }

            if (!confirm(`Are you sure you want to delete the expense "${expense.name}"?`)) return;

            try {
                showNotification('Deleting expense...', 'info');

                // Delete from database first if available
                if (typeof window.deleteExpenseFromDatabase === 'function') {
                    try {
                        await window.deleteExpenseFromDatabase(expenseId);
                        console.log('‚úÖ Expense deleted from database');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Database deletion failed:', error);
                    }
                }

                // Delete from local data
                const expenseIndex = currentGroup.expenses.findIndex(e => e.id === expenseId);
                if (expenseIndex !== -1) {
                    const deletedExpense = currentGroup.expenses[expenseIndex];
                    currentGroup.expenses.splice(expenseIndex, 1);
                    currentGroup.totalExpenses = Math.max(0, (currentGroup.totalExpenses || 0) - parseFloat(deletedExpense.amount));

                    // CRITICAL: Save changes immediately
                    updateGroupInStorage();

                    // Update UI
                    displayExpenses();
                    calculateBalances();
                    safeUpdateElement('totalExpensesAmount', formatCurrency(currentGroup.totalExpenses));

                    showNotification('Expense deleted successfully!', 'success');
                }
            } catch (error) {
                console.error('Delete expense failed:', error);
                showNotification(`Failed to delete expense: ${error.message}`, 'error');
            }
        }

        // ========================================
        // GROUP FUNCTIONS
        // ========================================
        function shareGroup() {
            const modal = document.getElementById('shareModal');
            const shareLink = document.getElementById('shareLink');
            const url = window.location.href;

            if (shareLink) shareLink.value = url;
            if (modal) modal.style.display = 'block';
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            if (shareLink) {
                shareLink.select();
                document.execCommand('copy');
                showNotification('Link copied to clipboard!', 'success');
            }
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) modal.style.display = 'none';
        }

        // FIXED: Edit Group function with proper error handling
        function handleEditGroup() {
            console.log('Edit button clicked');
            console.log('Current group:', window.currentGroup || currentGroup);

            try {
                editGroup();
            } catch (error) {
                console.error('Error in editGroup:', error);
                showNotification('Failed to open edit dialog', 'error');
            }
        }

        function editGroup() {
            const group = window.currentGroup || currentGroup;

            if (!group) {
                console.error('No current group found');
                showNotification('Group data not available', 'error');
                return;
            }

            // Populate group name
            const nameInput = document.getElementById('editGroupName');
            if (nameInput) {
                nameInput.value = group.name;
            }

            // Setup members
            setupEditGroupMembers();

            // Show modal
            const modal = document.getElementById('editGroupModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function setupEditGroupMembers() {
            const group = window.currentGroup || currentGroup;

            if (!group || !group.members) {
                return;
            }

            const grid = document.getElementById('editGroupMembersGrid');
            if (!grid) {
                return;
            }

            grid.innerHTML = group.members.map(member => `
                <div class="selectable-box selected" data-member="${member}">
                    ${member}
                </div>
            `).join('');
        }

        function selectAllGroupMembers() {
            document.querySelectorAll('#editGroupMembersGrid .selectable-box').forEach(box => {
                box.classList.add('selected');
            });
        }

        function clearAllGroupMembers() {
            document.querySelectorAll('#editGroupMembersGrid .selectable-box').forEach(box => {
                box.classList.remove('selected');
            });
        }

        function addNewGroupMember() {
            const input = document.getElementById('editGroupNewMemberInput');
            const memberName = input.value.trim();

            if (!memberName) return;

            const existingMembers = Array.from(document.querySelectorAll('#editGroupMembersGrid .selectable-box')).map(box => box.dataset.member);
            const dynamicMembers = Array.from(document.querySelectorAll('#editGroupDynamicMembers .dynamic-item-name')).map(el => el.textContent);

            if (existingMembers.includes(memberName) || dynamicMembers.includes(memberName)) {
                showNotification('Member already exists', 'error');
                return;
            }

            const dynamicContainer = document.getElementById('editGroupDynamicMembers');
            const itemId = `editgroupmember${dynamicMemberCounter++}`;
            const memberItem = document.createElement('div');
            memberItem.className = 'dynamic-item';
            memberItem.id = itemId;
            memberItem.innerHTML = `
                <div class="dynamic-item-content">
                    <span class="dynamic-item-name">${memberName}</span>
                </div>
                <div class="dynamic-item-actions">
                    <button class="icon-btn edit" onclick="editGroupMember('${itemId}')" title="Edit">‚úèÔ∏è</button>
                    <button class="icon-btn delete" onclick="removeGroupMember('${itemId}')" title="Remove">üóëÔ∏è</button>
                </div>
            `;

            dynamicContainer.appendChild(memberItem);
            input.value = '';
            showNotification('Member added successfully', 'success');
        }

        function editGroupMember(itemId) {
            const item = document.getElementById(itemId);
            const nameEl = item.querySelector('.dynamic-item-name');
            const currentName = nameEl.textContent;
            const newName = prompt('Edit member name:', currentName);

            if (newName && newName.trim() && newName.trim() !== currentName) {
                nameEl.textContent = newName.trim();
                showNotification('Member updated', 'success');
            }
        }

        function removeGroupMember(itemId) {
            if (confirm('Remove this member?')) {
                document.getElementById(itemId).remove();
                showNotification('Member removed', 'success');
            }
        }

        // FIXED: Save group changes with database synchronization
        async function saveGroupChanges() {
            const groupName = document.getElementById('editGroupName')?.value.trim();
            const selectedBoxes = document.querySelectorAll('#editGroupMembersGrid .selectable-box.selected');
            const selectedMembers = Array.from(selectedBoxes).map(box => box.dataset.member);

            const dynamicMembers = Array.from(document.querySelectorAll('#editGroupDynamicMembers .dynamic-item-name')).map(el => el.textContent);

            const allMembers = [...selectedMembers, ...dynamicMembers];

            if (!groupName || allMembers.length < 2) {
                showNotification('Please provide group name and at least two members', 'error');
                return;
            }

            try {
                const group = window.currentGroup || currentGroup;

                // Update group data
                group.name = groupName;
                group.members = allMembers;

                // Update both references
                currentGroup = group;
                window.currentGroup = group;

                // CRITICAL: Save to storage
                updateGroupInStorage();

                // Sync to database if available
                if (typeof window.syncGroupToDatabase === 'function') {
                    try {
                        await window.syncGroupToDatabase(group);
                    } catch (dbError) {
                        console.warn('Database sync failed:', dbError);
                    }
                }

                // Update UI
                updateGroupDisplay();

                closeEditGroupModal();
                showNotification('Group updated successfully!');

            } catch (error) {
                console.error('Failed to save group changes:', error);
                showNotification('Failed to update group', 'error');
            }
        }

        function closeEditGroupModal() {
            document.getElementById('editGroupModal').style.display = 'none';
            document.getElementById('editGroupDynamicMembers').innerHTML = '';
        }

        // FIXED: Delete group with database sync
        async function deleteGroupConfirm() {
            if (!currentGroup) {
                showNotification('No group to delete', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete the group "${currentGroup.name}"? All expenses will be lost forever!`)) return;

            try {
                // Delete from database first (if online)
                if (typeof window.deleteGroupFromDatabase === 'function') {
                    await window.deleteGroupFromDatabase(currentGroupId);
                }

                // Delete from local storage
                const groups = loadFromLocalStorage().filter(g => g.id !== currentGroupId);
                saveGroupsToLocalStorage(groups);

                showNotification('Group deleted successfully!');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                console.error('Failed to delete group:', error);
                showNotification('Failed to delete group from cloud. Deleted locally only.', 'warning');

                const groups = loadFromLocalStorage().filter(g => g.id !== currentGroupId);
                saveGroupsToLocalStorage(groups);

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(amount || 0);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Toggle selectable boxes
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('selectable-box')) {
                e.target.classList.toggle('selected');
            }
        });

        // Modal close handlers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Enter key for adding members
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'editGroupNewMemberInput') {
                addNewGroupMember();
            }
        });

        // Debug: Log when script is fully loaded
        console.log('‚úÖ Group detail script fully loaded with FIXED expense persistence');
    </script>

    <!-- External Scripts -->
    <script src="js/shared-utils.js"></script>
    <script src="js/shared-supabase.js"></script>
    <script src="js/shared-sync.js"></script>
</body>
</html>